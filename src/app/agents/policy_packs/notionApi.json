{
  "id": "notion_policy_v1",
  "match": {
    "source_servers": ["notionApi"]
  },
  "inject": {
    "append_system_message": [
      "NOTION CONTEXT:",
      "NOTES_PARENT_PAGE_ID={{NOTES_PARENT_PAGE_ID}}",
      "- When creating a page/note, ALWAYS use parent.page_id = NOTES_PARENT_PAGE_ID.",
      "- Do NOT hardcode or invent page/database IDs.",
      "- If NOTES_PARENT_PAGE_ID is missing/unresolved, ask the user where to save.",
      "- IMPORTANT: For user intent SAVE / NOTE / REMEMBER / ADD / STORE, you MUST create a NEW PAGE using notionApi_API-post-page (not a comment).",
      "- If you do NOT have access to notionApi_API-post-page in your tool list, you MUST transfer back to supervisor instead of using comments.",
      "- Treat Notion HTTP 400 validation_error the same as schema validation_error: fix payload and retry once; if it repeats, stop and ask for clarification.",
      "- CRITICAL SHAPE RULE: children MUST be a TOP-LEVEL field (sibling of properties), NEVER nested inside properties.",
      "- CRITICAL SHAPE RULE: properties must ONLY contain property values (e.g. title). Do NOT put children inside properties.",
      "- CRITICAL SHAPE RULE: For a page under parent.page_id, the title property object MUST look like: {\"title\": {\"title\": [ ...rich_text... ]}}. Do NOT add unrelated keys like id/name/start/lat.",
      "",
      "NOTION API REQUEST SHAPES (copy these patterns):",
      "",
      "1) CREATE PAGE (notionApi_API-post-page) under a parent page:",
      "   - REQUIRED: parent.page_id OR parent.database_id",
      "   - REQUIRED: properties.title.title (array of rich_text objects)",
      "   - OPTIONAL: children (array of block objects)",
      "   Example:",
      "   {",
      "     \"parent\": { \"page_id\": NOTES_PARENT_PAGE_ID },",
      "     \"properties\": {",
      "       \"title\": {",
      "         \"title\": [",
      "           { \"type\": \"text\", \"text\": { \"content\": \"My note title\" } }",
      "         ]",
      "       }",
      "     },",
      "     \"children\": [",
      "       {",
      "         \"object\": \"block\",",
      "         \"type\": \"paragraph\",",
      "         \"paragraph\": {",
      "           \"rich_text\": [",
      "             { \"type\": \"text\", \"text\": { \"content\": \"Full note body here\" } }",
      "           ]",
      "         }",
      "       }",
      "     ]",
      "   }",
      "",
      "2) UPDATE PAGE METADATA (notionApi_API-patch-page):",
      "   - Use this to update title/properties or to archive (delete-like).",
      "   Example (update title):",
      "   {",
      "     \"page_id\": \"<PAGE_ID>\",",
      "     \"properties\": {",
      "       \"title\": {",
      "         \"title\": [",
      "           { \"type\": \"text\", \"text\": { \"content\": \"New title\" } }",
      "         ]",
      "       }",
      "     }",
      "   }",
      "",
      "3) DELETE PAGE (Notion has no hard delete; archive instead) (notionApi_API-patch-page):",
      "   Example (archive):",
      "   {",
      "     \"page_id\": \"<PAGE_ID>\",",
      "     \"archived\": true",
      "   }",
      "",
      "4) APPEND BLOCKS TO A PAGE (common tool: notionApi_API-patch-block-children or similar):",
      "   - children MUST be an array of block OBJECTS (never strings).",
      "   - paragraph content MUST be under paragraph.rich_text (not paragraph.text).",
      "   Example:",
      "   {",
      "     \"block_id\": \"<PAGE_ID_OR_BLOCK_ID>\",",
      "     \"children\": [",
      "       {",
      "         \"object\": \"block\",",
      "         \"type\": \"paragraph\",",
      "         \"paragraph\": {",
      "           \"rich_text\": [",
      "             { \"type\": \"text\", \"text\": { \"content\": \"More content\" } }",
      "           ]",
      "         }",
      "       }",
      "     ]",
      "   }",
      "",
      "VALIDATION / REPAIR:",
      "- If Notion returns 400 validation_error, read the message and adjust the payload to match the patterns above.",
      "- If a tool returns a local schema validation_error, consult args_schema and fix args before retrying."
    ]
  }
}

